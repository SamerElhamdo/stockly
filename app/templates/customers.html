{% extends 'base.html' %}

{% block title %}ุฅุฏุงุฑุฉ ุงูุนููุงุก - Stockly{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white"> ุฅุฏุงุฑุฉ ุงูุนููุงุก</h1>    
            <p class="mt-2 text-gray-600 dark:text-gray-400">ุฅุฏุงุฑุฉ ุจูุงูุงุช ุงูุนููุงุก ูููุงุชูุฑูู</p>
        </div>
        <button onclick="showAddCustomerModal()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center">
            <span class="text-xl mr-2"></span>
            ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ
        </button>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <input id="searchInput" type="text" placeholder="ุงูุจุญุซ ุจุงูุงุณู ุฃู ุงููุงุชู ุฃู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู..."
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
            </div>
            <button onclick="searchCustomers()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                ๐ ุจุญุซ
            </button>
        </div>
    </div>

    <!-- Customers Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">ูุงุฆูุฉ ุงูุนููุงุก</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุงูุงุณู</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุงููุงุชู</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุงููุณุชุญูุงุช</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุนุฏุฏ ุงูููุงุชูุฑ</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุนุฏุฏ ุงููุฑุชุฌุนุงุช</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุขุฎุฑ ุนูููุฉ ุดุฑุงุก</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ุงูุฅุฌุฑุงุกุงุช</th>
                    </tr>
                </thead>
                <tbody id="customersTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            <span class="text-4xl">๐ฅ</span>
                            <p class="mt-2">ุฌุงุฑู ุชุญููู ุงูุนููุงุก...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div id="addCustomerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ</h3>
            <form id="addCustomerForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุงุณู *</label>
                    <input id="customerName" type="text" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุงุชู</label>
                    <input id="customerPhone" type="tel"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                    <input id="customerEmail" type="email"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุนููุงู</label>
                    <textarea id="customerAddress" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddCustomerModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                        ุฅูุบุงุก
                    </button>
                    <button type="submit" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md">
                        ุฅุถุงูุฉ ุงูุนููู
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Payment Modal -->
<div id="addPaymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ุฅุถุงูุฉ ุฏูุนุฉ ุฌุฏูุฏุฉ</h3>
                <button onclick="closeAddPaymentModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="addPaymentForm">
                <input type="hidden" id="paymentCustomerId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุนููู</label>
                        <input type="text" id="paymentCustomerName" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุงุชูุฑุฉ (ุงุฎุชูุงุฑู)</label>
                        <select id="paymentInvoiceSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">ุงุฎุชุฑ ุงููุงุชูุฑุฉ (ุงุฎุชูุงุฑู)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุจูุบ *</label>
                        <input type="number" id="paymentAmount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุทุฑููุฉ ุงูุฏูุน *</label>
                        <select id="paymentMethod" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="cash">ููุฏุงู</option>
                            <option value="bank_transfer">ุชุญููู ุจููู</option>
                            <option value="check">ุดูู</option>
                            <option value="credit_card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                            <option value="other">ุฃุฎุฑู</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ููุงุญุธุงุช</label>
                        <textarea id="paymentNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeAddPaymentModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-md">
                        ุฅูุบุงุก
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                        ุฅุถุงูุฉ ุงูุฏูุนุฉ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Withdraw Payment Modal -->
<div id="withdrawPaymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ุณุญุจ ุฏูุนุฉ</h3>
                <button onclick="closeWithdrawPaymentModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="withdrawPaymentForm">
                <input type="hidden" id="withdrawCustomerId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุนููู</label>
                        <input type="text" id="withdrawCustomerName" readonly class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุจูุบ *</label>
                        <input type="number" id="withdrawAmount" step="0.01" min="0" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุทุฑููุฉ ุงูุณุญุจ *</label>
                        <select id="withdrawMethod" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="cash">ููุฏุงู</option>
                            <option value="bank_transfer">ุชุญููู ุจููู</option>
                            <option value="check">ุดูู</option>
                            <option value="credit_card">ุจุทุงูุฉ ุงุฆุชูุงู</option>
                            <option value="other">ุฃุฎุฑู</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ููุงุญุธุงุช</label>
                        <textarea id="withdrawNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeWithdrawPaymentModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 rounded-md">
                        ุฅูุบุงุก
                    </button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-md">
                        ุณุญุจ ุงูุฏูุนุฉ
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Load customers data
async function loadCustomers() {
    try {
        const res = await fetch('/api/customers/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        const customers = await res.json();
        
        const tbody = document.getElementById('customersTableBody');
        if (customers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-users text-4xl mb-4 text-gray-400"></i>
                        <p class="mt-2 font-cairo">ูุง ุชูุฌุฏ ุนููุงุก ุญุงููุงู</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = customers.map(customer => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">${customer.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-600 dark:text-gray-400">${customer.phone || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-600 dark:text-gray-400">${customer.email || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${customer.balance > 0 ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400' : 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'}">
                        ${customer.balance ? customer.balance.toFixed(2) : '0.00'} $
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400">
                        ${customer.invoices_count || 0}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-400">
                        ${customer.returns_count || 0}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-600 dark:text-gray-400">${customer.last_purchase || '-'}</div>
                </td>
                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="grid grid-cols-2 gap-2">
                        <!-- ุงูุนูููุงุช ุงูุฃุณุงุณูุฉ -->
                        <div class="space-y-1.5">
                            <button onclick="createInvoiceForCustomer(${customer.id}, '${customer.name}')" 
                                    class="w-full flex flex-col items-center p-2 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors duration-200 group action-button">
                                <i class="fas fa-file-invoice text-sm mb-0.5 action-icon"></i>
                                <span class="text-xs font-medium action-text">ูุงุชูุฑุฉ</span>
                            </button>
                            <button onclick="createReturnForCustomer(${customer.id}, '${customer.name}')" 
                                    class="w-full flex flex-col items-center p-2 bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors duration-200 group action-button">
                                <i class="fas fa-undo text-sm mb-0.5 action-icon"></i>
                                <span class="text-xs font-medium action-text">ูุฑุชุฌุน</span>
                            </button>
                        </div>
                        
                        <!-- ุงููุฏููุนุงุช -->
                        <div class="space-y-1.5">
                            <button onclick="addPaymentForCustomer(${customer.id}, '${customer.name}')" 
                                    class="w-full flex flex-col items-center p-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors duration-200 group action-button">
                                <i class="fas fa-plus text-sm mb-0.5 action-icon"></i>
                                <span class="text-xs font-medium action-text">ุฅุถุงูุฉ</span>
                            </button>
                            <button onclick="withdrawPaymentForCustomer(${customer.id}, '${customer.name}')" 
                                    class="w-full flex flex-col items-center p-2 bg-orange-600 hover:bg-orange-700 text-white rounded-md transition-colors duration-200 group action-button">
                                <i class="fas fa-minus text-sm mb-0.5 action-icon"></i>
                                <span class="text-xs font-medium action-text">ุณุญุจ</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- ุงูุฅุฏุงุฑุฉ -->
                    <div class="mt-2 flex justify-center space-x-1">
                        <button onclick="viewCustomer(${customer.id})" 
                                class="flex flex-col items-center p-1.5 text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 hover:bg-primary-50 dark:hover:bg-primary-900/20 rounded-md transition-colors duration-200 group action-button">
                            <i class="fas fa-eye text-xs mb-0.5 action-icon"></i>
                            <span class="text-xs action-text">ุนุฑุถ</span>
                        </button>
                        <button onclick="editCustomer(${customer.id})" 
                                class="flex flex-col items-center p-1.5 text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 hover:bg-yellow-50 dark:hover:bg-yellow-900/20 rounded-md transition-colors duration-200 group action-button">
                            <i class="fas fa-edit text-xs mb-0.5 action-icon"></i>
                            <span class="text-xs action-text">ุชุนุฏูู</span>
                        </button>
                        <button onclick="archiveCustomer(${customer.id})" 
                                class="flex flex-col items-center p-1.5 text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors duration-200 group action-button">
                            <i class="fas fa-archive text-xs mb-0.5 action-icon"></i>
                            <span class="text-xs action-text">ุฃุฑุดูุฉ</span>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

function showAddCustomerModal() {
    document.getElementById('addCustomerModal').classList.remove('hidden');
}

function closeAddCustomerModal() {
    document.getElementById('addCustomerModal').classList.add('hidden');
    document.getElementById('addCustomerForm').reset();
}

async function addCustomer(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('customerName').value,
        phone: document.getElementById('customerPhone').value,
        email: document.getElementById('customerEmail').value,
        address: document.getElementById('customerAddress').value
    };
    
    try {
        const res = await fetch('/api/customers/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify(formData)
        });
        
        if (res.ok) {
            closeAddCustomerModal();
            loadCustomers();
            showNotification('โ ุชู ุฅุถุงูุฉ ุงูุนููู ุจูุฌุงุญ', 'success');
        } else {
            showNotification('โ ุญุฏุซ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุนููู', 'error');
        }
    } catch (error) {
        console.error('Error adding customer:', error);
        showNotification('โ ุญุฏุซ ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุนููู', 'error');
    }
}

function searchCustomers() {
    const query = document.getElementById('searchInput').value;
    // Implement search functionality
    console.log('Searching for:', query);
}

async function viewCustomer(customerId) {
    try {
        // Get customer data
        const res = await fetch(`/api/customers/${customerId}/invoices/`, {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (!res.ok) {
            showNotification('โ ูุดู ูู ุชุญููู ุจูุงูุงุช ุงูุนููู', 'error');
            return;
        }
        
        const invoices = await res.json();
        
        // Get customer basic info from the current customers list
        const customers = await fetch('/api/customers/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        }).then(r => r.json());
        
        const customer = customers.find(c => c.id === customerId);
        if (!customer) {
            showNotification('โ ุงูุนููู ุบูุฑ ููุฌูุฏ', 'error');
            return;
        }
        
        // Create view modal
        const modalHtml = `
        <div id="viewCustomerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 backdrop-blur-sm">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white">ุชูุงุตูู ุงูุนููู</h3>
                            <button onclick="closeViewCustomerModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุงูุงุณู</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">${customer.name}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุงููุงุชู</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">${customer.phone || '-'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">${customer.email || '-'}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุงูุนููุงู</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">${customer.address || '-'}</p>
                                </div>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุงููุณุชุญูุงุช</label>
                                    <p class="mt-1 text-sm font-semibold ${customer.balance > 0 ? 'text-red-600' : 'text-green-600'}">
                                        ${customer.balance ? customer.balance.toFixed(2) : '0.00'} $
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุนุฏุฏ ุงูููุงุชูุฑ</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">${customer.invoices_count || 0}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุนุฏุฏ ุงููุฑุชุฌุนุงุช</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">${customer.returns_count || 0}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">ุขุฎุฑ ุนูููุฉ ุดุฑุงุก</label>
                                    <p class="mt-1 text-sm text-gray-900 dark:text-white">${customer.last_purchase || '-'}</p>
                                </div>
                            </div>
                        </div>
                        
                        ${invoices.length > 0 ? `
                        <div class="mt-6">
                            <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">ุงูููุงุชูุฑ ุงูุฃุฎูุฑุฉ</h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${invoices.slice(0, 5).map(invoice => `
                                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                                        <span class="text-sm font-medium text-gray-900 dark:text-white">ูุงุชูุฑุฉ #${invoice.id}</span>
                                        <span class="text-sm text-gray-600 dark:text-gray-400">${invoice.total_amount.toFixed(2)} $</span>
                                        <span class="text-xs text-gray-500 dark:text-gray-400">${invoice.created_at}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button onclick="closeViewCustomerModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                                ุฅุบูุงู
                            </button>
                            <button onclick="editCustomer(${customerId})" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-md">
                                <i class="fas fa-edit ml-2"></i>ุชุนุฏูู
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    } catch (error) {
        console.error('Error viewing customer:', error);
        showNotification('โ ุญุฏุซ ุฎุทุฃ ูู ุนุฑุถ ุจูุงูุงุช ุงูุนููู', 'error');
    }
}

function closeViewCustomerModal() {
    const modal = document.getElementById('viewCustomerModal');
    if (modal) modal.remove();
}

async function editCustomer(customerId) {
    try {
        // Close view modal if open
        closeViewCustomerModal();
        
        // Get customer data
        const res = await fetch('/api/customers/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (!res.ok) {
            showNotification('โ ูุดู ูู ุชุญููู ุจูุงูุงุช ุงูุนููู', 'error');
            return;
        }
        
        const customers = await res.json();
        const customer = customers.find(c => c.id === customerId);
        
        if (!customer) {
            showNotification('โ ุงูุนููู ุบูุฑ ููุฌูุฏ', 'error');
            return;
        }
        
        // Create edit modal
        const modalHtml = `
        <div id="editCustomerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 backdrop-blur-sm">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">ุชุนุฏูู ุงูุนููู</h3>
                        <button onclick="closeEditCustomerModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <form id="editCustomerForm">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุงุณู *</label>
                                <input id="editCustomerName" type="text" required value="${customer.name}"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงููุงุชู</label>
                                <input id="editCustomerPhone" type="tel" value="${customer.phone || ''}"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                                <input id="editCustomerEmail" type="email" value="${customer.email || ''}"
                                       class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ุงูุนููุงู</label>
                                <textarea id="editCustomerAddress" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">${customer.address || ''}</textarea>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button type="button" onclick="closeEditCustomerModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                                ุฅูุบุงุก
                            </button>
                            <button type="submit" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md">
                                <i class="fas fa-save ml-2"></i>ุญูุธ ุงูุชุนุฏููุงุช
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>`;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Add form event listener
        document.getElementById('editCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            updateCustomer(customerId);
        });
        
    } catch (error) {
        console.error('Error editing customer:', error);
        showNotification('โ ุญุฏุซ ุฎุทุฃ ูู ุชุญููู ุจูุงูุงุช ุงูุนููู', 'error');
    }
}

function closeEditCustomerModal() {
    const modal = document.getElementById('editCustomerModal');
    if (modal) modal.remove();
}

async function updateCustomer(customerId) {
    const formData = {
        name: document.getElementById('editCustomerName').value.trim(),
        phone: document.getElementById('editCustomerPhone').value.trim(),
        email: document.getElementById('editCustomerEmail').value.trim(),
        address: document.getElementById('editCustomerAddress').value.trim()
    };
    
    if (!formData.name) {
        showNotification('โ ุงุณู ุงูุนููู ูุทููุจ', 'error');
        return;
    }
    
    try {
        PageLoader.show('ุฌุงุฑู ุญูุธ ุงูุชุนุฏููุงุช...');
        
        const res = await fetch(`/api/customers/${customerId}/update/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify(formData)
        });
        
        PageLoader.hide();
        
        if (res.ok) {
            closeEditCustomerModal();
            loadCustomers();
            showNotification('โ ุชู ุชุญุฏูุซ ุจูุงูุงุช ุงูุนููู ุจูุฌุงุญ', 'success');
        } else {
            const error = await res.json().catch(() => ({}));
            showNotification('โ ูุดู ุชุญุฏูุซ ุงูุนููู' + (error.error ? `: ${error.error}` : ''), 'error');
        }
    } catch (error) {
        PageLoader.hide();
        console.error('Error updating customer:', error);
        showNotification('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุชุญุฏูุซ', 'error');
    }
}

async function archiveCustomer(customerId) {
    const confirmed = await showConfirmation(
        'ุฃุฑุดูุฉ ุงูุนููู',
        'ูู ุชุฑูุฏ ุฃุฑุดูุฉ ูุฐุง ุงูุนูููุ ุณูุชู ุฅุฎูุงุคู ูู ุงููุงุฆูุฉ ููู ูุคุซุฑ ุฐูู ุนูู ุงูููุงุชูุฑ ุงูุณุงุจูุฉ.',
        'ุฃุฑุดูุฉ',
        'ุฅูุบุงุก',
        'warning'
    );
    
    if (!confirmed) return;
    
        try {
        PageLoader.show('ุฌุงุฑู ุฃุฑุดูุฉ ุงูุนููู...');
        const res = await fetch(`/api/customers/${customerId}/archive/`, {
            method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                    'Authorization': 'Token ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({ archived: true })
            });
            
        PageLoader.hide();
            if (res.ok) {
            showNotification('๐ฆ ุชู ุฃุฑุดูุฉ ุงูุนููู ุจูุฌุงุญ', 'success');
                loadCustomers();
            } else {
            const err = await res.json().catch(() => ({}));
            showNotification('โ ูุดู ุฃุฑุดูุฉ ุงูุนููู' + (err.error ? `: ${err.error}` : ''), 'error');
        }
    } catch (error) {
        PageLoader.hide();
        console.error('Error archiving customer:', error);
        showNotification('โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุฃุฑุดูุฉ', 'error');
    }
}

// Create invoice for specific customer
async function createInvoiceForCustomer(customerId, customerName) {
    try {
        // Show confirmation dialog
        const confirmed = await showConfirmation(
            `ูู ุชุฑูุฏ ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ ููุนููู "${customerName}"ุ`,
            'ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ',
            'success'
        );
        
        if (!confirmed) return;
        
        // Create invoice session
        const res = await fetch('/api/invoices/session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({customer_name: customerName})
        });
        
        if (res.ok) {
            const data = await res.json();
            showSuccessNotification(`ุชู ุฅูุดุงุก ูุงุชูุฑุฉ ุฌุฏูุฏุฉ ููุนููู: ${customerName}`);
            // Redirect to invoice page
            window.location.href = `/invoice/${data.session_id}/`;
        } else {
            showErrorNotification('ุญุฏุซ ุฎุทุฃ ูู ุฅูุดุงุก ุงููุงุชูุฑุฉ');
        }
    } catch (error) {
        console.error('Error creating invoice for customer:', error);
        showErrorNotification('ุญุฏุซ ุฎุทุฃ ูู ุฅูุดุงุก ุงููุงุชูุฑุฉ');
    }
}

// Event listeners
document.getElementById('addCustomerForm').addEventListener('submit', addCustomer);
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchCustomers();
    }
});

// Add payment for customer
function addPaymentForCustomer(customerId, customerName) {
    document.getElementById('paymentCustomerId').value = customerId;
    document.getElementById('paymentCustomerName').value = customerName;
    
    // Load customer invoices
    loadCustomerInvoices(customerId);
    
    document.getElementById('addPaymentModal').classList.remove('hidden');
}

// Create return for customer
function createReturnForCustomer(customerId, customerName) {
    // Redirect to returns page with customer filter
    window.location.href = `/returns/?customer=${customerId}`;
}

// Withdraw payment for customer
function withdrawPaymentForCustomer(customerId, customerName) {
    document.getElementById('withdrawCustomerId').value = customerId;
    document.getElementById('withdrawCustomerName').value = customerName;
    document.getElementById('withdrawPaymentModal').classList.remove('hidden');
}

// Load customer invoices
async function loadCustomerInvoices(customerId) {
    try {
        const response = await fetch(`/api/customers/${customerId}/invoices/`, {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (response.ok) {
            const invoices = await response.json();
            populatePaymentInvoiceSelect(invoices);
        }
    } catch (error) {
        console.error('Error loading customer invoices:', error);
    }
}

// Populate payment invoice select
function populatePaymentInvoiceSelect(invoices) {
    const select = document.getElementById('paymentInvoiceSelect');
    select.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุงุชูุฑุฉ (ุงุฎุชูุงุฑู)</option>';
    
    invoices.forEach(invoice => {
        const option = document.createElement('option');
        option.value = invoice.id;
        option.textContent = `ูุงุชูุฑุฉ #${invoice.id} (${invoice.total_amount.toFixed(2)} $)`;
        select.appendChild(option);
    });
}

// Close add payment modal
function closeAddPaymentModal() {
    document.getElementById('addPaymentModal').classList.add('hidden');
    document.getElementById('addPaymentForm').reset();
}

// Close withdraw payment modal
function closeWithdrawPaymentModal() {
    document.getElementById('withdrawPaymentModal').classList.add('hidden');
    document.getElementById('withdrawPaymentForm').reset();
}

// Add payment form submission
document.getElementById('addPaymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        customer_id: document.getElementById('paymentCustomerId').value,
        invoice_id: document.getElementById('paymentInvoiceSelect').value || null,
        amount: document.getElementById('paymentAmount').value,
        payment_method: document.getElementById('paymentMethod').value,
        notes: document.getElementById('paymentNotes').value
    };
    
    try {
        const response = await fetch('/api/payments/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showNotification('ุชู ุฅุถุงูุฉ ุงูุฏูุนุฉ ุจูุฌุงุญ', 'success');
            closeAddPaymentModal();
            loadCustomers();
        } else {
            const error = await response.json();
            showNotification(error.error || 'ุฎุทุฃ ูู ุฅุถุงูุฉ ุงูุฏูุนุฉ', 'error');
        }
    } catch (error) {
        console.error('Error adding payment:', error);
        showNotification('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', 'error');
    }
});

// Withdraw payment form submission
document.getElementById('withdrawPaymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        customer_id: document.getElementById('withdrawCustomerId').value,
        amount: -parseFloat(document.getElementById('withdrawAmount').value), // Negative amount for withdrawal
        payment_method: document.getElementById('withdrawMethod').value,
        notes: document.getElementById('withdrawNotes').value
    };
    
    try {
        const response = await fetch('/api/payments/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            showNotification('ุชู ุณุญุจ ุงูุฏูุนุฉ ุจูุฌุงุญ', 'success');
            closeWithdrawPaymentModal();
            loadCustomers();
        } else {
            const error = await response.json();
            showNotification(error.error || 'ุฎุทุฃ ูู ุณุญุจ ุงูุฏูุนุฉ', 'error');
        }
    } catch (error) {
        console.error('Error withdrawing payment:', error);
        showNotification('ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู', 'error');
    }
});

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show loader while loading data
    PageLoader.show('ุฌุงุฑู ุชุญููู ุงูุนููุงุก...');
    
    loadCustomers().then(() => {
        // Hide loader after data is loaded
        PageLoader.hide();
    }).catch((error) => {
        console.error('Error loading customers:', error);
        PageLoader.hide();
    });
});
</script>

<style>
    /* ุชุญุณูู ูุธูุฑ ุฃุฒุฑุงุฑ ุงูุฅุฌุฑุงุกุงุช */
    .action-button {
        transition: all 0.2s ease-in-out;
    }
    
    .action-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .action-button:active {
        transform: translateY(0);
    }
    
    /* ุชุญุณูู ูุธูุฑ ุงูุฃููููุงุช */
    .action-icon {
        transition: transform 0.2s ease-in-out;
    }
    
    .action-button:hover .action-icon {
        transform: scale(1.1);
    }
    
    /* ุชุญุณูู ูุธูุฑ ุงููุตูุต */
    .action-text {
        font-weight: 500;
        letter-spacing: 0.025em;
    }
</style>

{% endblock %}
