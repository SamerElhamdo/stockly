<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stockly - نظام إدارة المخزون والفواتير</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        'cairo': ['Cairo', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        .font-cairo { font-family: 'Cairo', sans-serif; }
        .bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-gradient-secondary { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .bg-gradient-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .bg-gradient-warning { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-cairo min-h-screen">
    <!-- Notifications -->
    <div id="notificationContainer"></div>

    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <!-- Header -->
            <div class="text-center">
                <div class="mx-auto h-20 w-20 bg-gradient-primary rounded-full flex items-center justify-center mb-6">
                    <i class="fas fa-store text-white text-3xl"></i>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 dark:text-white">
                    مرحباً بك في Stockly
                </h2>
                <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                    نظام إدارة المخزون والفواتير
                </p>
            </div>

            <!-- Tab Navigation -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700">
                <div class="flex border-b border-gray-200 dark:border-gray-600">
                    <button id="loginTab" class="flex-1 py-4 px-6 text-center font-medium text-primary-600 dark:text-primary-400 border-b-2 border-primary-600 dark:border-primary-400 bg-primary-50 dark:bg-primary-900/20">
                        <i class="fas fa-sign-in-alt ml-2"></i>
                        تسجيل الدخول
                    </button>
                    <button id="companyTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                        <i class="fas fa-building ml-2"></i>
                        تسجيل شركة
                    </button>
                    <button id="staffTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                        <i class="fas fa-user-plus ml-2"></i>
                        تسجيل موظف
                    </button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="p-6">
                    <!-- Django Messages -->
                    {% if messages %}
                        {% for message in messages %}
                            <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-800 dark:text-red-400{% elif message.tags == 'success' %}bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-800 dark:text-green-400{% else %}bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 text-blue-800 dark:text-blue-400{% endif %}">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-{% if message.tags == 'error' %}exclamation-triangle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %}"></i>
                                    </div>
                                    <div class="mr-3">
                                        <div class="text-sm font-medium">
                                            {{ message }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <form method="post" class="space-y-6">
                        {% csrf_token %}
                        <div>
                            <label for="id_username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-user ml-2"></i>اسم المستخدم
                            </label>
                            <input id="id_username" name="username" type="text" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                   placeholder="أدخل اسم المستخدم">
                        </div>

                        <div>
                            <label for="id_password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-lock ml-2"></i>كلمة المرور
                            </label>
                            <input id="id_password" name="password" type="password" required
                                   class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                   placeholder="أدخل كلمة المرور">
                        </div>

                        <div>
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition duration-150 ease-in-out">
                                <i class="fas fa-sign-in-alt ml-2"></i>
                                تسجيل الدخول
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Company Registration Form -->
                <div id="companyForm" class="p-6 hidden">
                    <form id="companyRegistrationForm" class="space-y-6">
                        <!-- Company Information -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-building ml-2"></i>معلومات الشركة
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="companyName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        اسم الشركة *
                                    </label>
                                    <input id="companyName" name="companyName" type="text" required
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                           placeholder="أدخل اسم الشركة">
                                </div>

                                <div>
                                    <label for="companyCode" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        المعرف الخاص بالشركة *
                                    </label>
                                    <input id="companyCode" name="companyCode" type="text" required
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                           placeholder="مثال: TECH2024">
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        معرف فريد للشركة (أحرف إنجليزية وأرقام فقط)
                                    </p>
                                </div>

                                <div>
                                    <label for="companyPhone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        رقم الهاتف (واتساب) *
                                    </label>
                                    <div class="flex space-x-2 space-x-reverse">
                                        <input id="companyPhone" name="companyPhone" type="tel" required
                                               class="flex-1 mt-1 block px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                               placeholder="966501234567">
                                        <button type="button" id="sendOTPBtn" 
                                                class="mt-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm font-medium transition-colors duration-200">
                                            <i class="fab fa-whatsapp ml-1"></i>
                                            <span id="sendOTPText">إرسال رمز التحقق</span>
                                        </button>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        سيتم إرسال رمز التحقق عبر واتساب (بدون علامة +)
                                    </p>
                                </div>

                                <!-- OTP Verification -->
                                <div id="otpSection" class="hidden">
                                    <label for="otpCode" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        رمز التحقق *
                                    </label>
                                    <div class="flex space-x-2 space-x-reverse">
                                        <input id="otpCode" name="otpCode" type="text" maxlength="6"
                                               class="flex-1 mt-1 block px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white text-center text-lg font-mono"
                                               placeholder="123456">
                                        <button type="button" id="verifyOTPBtn" 
                                                class="mt-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-medium transition-colors duration-200">
                                            <i class="fas fa-check ml-1"></i>
                                            <span id="verifyOTPText">تحقق</span>
                                        </button>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        أدخل الرمز المكون من 6 أرقام المرسل عبر واتساب
                                    </p>
                                    <div id="otpStatus" class="mt-2 text-sm font-medium"></div>
                                </div>

                                <!-- Admin Account Creation (shown after OTP verification) -->
                                <div id="adminAccountSection" class="hidden">
                                    <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">
                                        <i class="fas fa-user-shield ml-2"></i>إنشاء حساب المدير
                                    </h4>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <label for="adminUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                اسم المستخدم *
                                            </label>
                                            <input id="adminUsername" name="adminUsername" type="text" required
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                                   placeholder="مثال: admin_tech2024">
                                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                                اسم المستخدم لحساب المدير
                                            </p>
                                        </div>

                                        <div>
                                            <label for="adminPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                كلمة المرور *
                                            </label>
                                            <input id="adminPassword" name="adminPassword" type="password" required
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                                   placeholder="أدخل كلمة مرور قوية">
                                        </div>

                                        <div>
                                            <label for="adminPasswordConfirm" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                                تأكيد كلمة المرور *
                                            </label>
                                            <input id="adminPasswordConfirm" name="adminPasswordConfirm" type="password" required
                                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                                   placeholder="أعد إدخال كلمة المرور">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>


                        <!-- Submit Button -->
                        <div class="pt-4">
                            <button type="submit" id="companySubmitBtn"
                                    class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                                <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                                    <i class="fas fa-building text-primary-500 group-hover:text-primary-400"></i>
                                </span>
                                <span id="companySubmitText">إنشاء الشركة</span>
                                <span id="companyLoadingSpinner" class="hidden ml-2">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Staff Registration Form -->
                <div id="staffForm" class="p-6 hidden">
                    <form id="staffRegistrationForm" class="space-y-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-user-plus ml-2"></i>معلومات الموظف
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label for="staffUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        اسم المستخدم *
                                    </label>
                                    <input id="staffUsername" name="staffUsername" type="text" required
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                           placeholder="أدخل اسم المستخدم">
                                </div>

                                <div>
                                    <label for="staffEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        البريد الإلكتروني *
                                    </label>
                                    <input id="staffEmail" name="staffEmail" type="email" required
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                           placeholder="staff@company.com">
                                </div>

                                <div>
                                    <label for="staffPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        كلمة المرور *
                                    </label>
                                    <input id="staffPassword" name="staffPassword" type="password" required
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                           placeholder="كلمة مرور قوية">
                                </div>

                                <div>
                                    <label for="staffPasswordConfirm" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        تأكيد كلمة المرور *
                                    </label>
                                    <input id="staffPasswordConfirm" name="staffPasswordConfirm" type="password" required
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                           placeholder="أعد إدخال كلمة المرور">
                                </div>

                                <div>
                                    <label for="staffPhone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        رقم الهاتف
                                    </label>
                                    <input id="staffPhone" name="staffPhone" type="tel"
                                           class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white"
                                           placeholder="966501234567">
                                </div>

                                <div>
                                    <label for="staffRole" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        الدور *
                                    </label>
                                    <select id="staffRole" name="staffRole" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:text-white">
                                        <option value="">اختر الدور</option>
                                        <option value="staff">موظف</option>
                                        <option value="owner">مالك الشركة</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="pt-4">
                            <button type="submit" id="staffSubmitBtn"
                                    class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200">
                                <i class="fas fa-user-plus ml-2"></i>
                                <span id="staffSubmitText">إضافة الموظف</span>
                                <span id="staffLoadingSpinner" class="hidden ml-2">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dark Mode Toggle -->
            <div class="text-center">
                <button onclick="toggleDarkMode()" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 transition duration-150 ease-in-out">
                    <i id="darkModeIcon" class="fas fa-moon text-xl"></i>
                </button>
            </div>

            <!-- Footer -->
            <div class="text-center text-sm text-gray-500 dark:text-gray-400">
                <p>&copy; 2024 Stockly. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let otpVerified = false;
        let otpSessionId = null;
        let currentTab = 'login';
        let countdownInterval = null; // Store countdown interval

        // Tab switching
        function switchTab(tabName) {
            // Reset OTP state when switching tabs
            if (tabName !== 'company') {
                // Clear any existing countdown
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }
                
                otpVerified = false;
                otpSessionId = null;
                document.getElementById('otpSection').classList.add('hidden');
                document.getElementById('adminAccountSection').classList.add('hidden');
                document.getElementById('otpCode').value = '';
                document.getElementById('otpStatus').innerHTML = '';
                
                // Reset OTP button states
                const sendOTPBtn = document.getElementById('sendOTPBtn');
                const sendOTPText = document.getElementById('sendOTPText');
                const verifyOTPBtn = document.getElementById('verifyOTPBtn');
                const verifyOTPText = document.getElementById('verifyOTPText');
                
                sendOTPBtn.disabled = false;
                sendOTPText.textContent = 'إرسال رمز التحقق';
                verifyOTPBtn.disabled = false;
                verifyOTPText.textContent = 'تحقق';
                verifyOTPBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
            
            // Hide all forms
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('companyForm').classList.add('hidden');
            document.getElementById('staffForm').classList.add('hidden');
            
            // Remove active styles from all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.remove('text-primary-600', 'dark:text-primary-400', 'border-primary-600', 'dark:border-primary-400', 'bg-primary-50', 'dark:bg-primary-900/20');
                tab.classList.add('text-gray-500', 'dark:text-gray-400');
            });
            
            // Show selected form and style tab
            document.getElementById(tabName + 'Form').classList.remove('hidden');
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('text-gray-500', 'dark:text-gray-400');
            activeTab.classList.add('text-primary-600', 'dark:text-primary-400', 'border-primary-600', 'dark:border-primary-400', 'bg-primary-50', 'dark:bg-primary-900/20');
            
            currentTab = tabName;
        }

        // Tab event listeners
        document.getElementById('loginTab').addEventListener('click', () => switchTab('login'));
        document.getElementById('companyTab').addEventListener('click', () => switchTab('company'));
        document.getElementById('staffTab').addEventListener('click', () => switchTab('staff'));

        // Dark Mode Toggle
        function toggleDarkMode() {
            const html = document.documentElement;
            const icon = document.getElementById('darkModeIcon');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.className = 'fas fa-moon text-xl';
                localStorage.setItem('darkMode', 'false');
            } else {
                html.classList.add('dark');
                icon.className = 'fas fa-sun text-xl';
                localStorage.setItem('darkMode', 'true');
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="flex items-center p-4 rounded-lg text-white shadow-lg">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} ml-3"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="mr-auto text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function showSuccessNotification(message) {
            showNotification(message, 'success');
        }

        function showErrorNotification(message) {
            showNotification(message, 'error');
        }

        function showWarningNotification(message) {
            showNotification(message, 'warning');
        }

        function showInfoNotification(message) {
            showNotification(message, 'info');
        }

        // Login form will be handled by Django

        // OTP functionality for company registration
        document.getElementById('sendOTPBtn').addEventListener('click', async function() {
            const phone = document.getElementById('companyPhone').value.trim();
            const sendOTPBtn = document.getElementById('sendOTPBtn');
            const sendOTPText = document.getElementById('sendOTPText');
            
            if (!phone) {
                showErrorNotification('يرجى إدخال رقم الهاتف أولاً');
                return;
            }
            
            // Remove any + signs and spaces from phone number
            const cleanPhone = phone.replace(/[\+\s\-\(\)]/g, '');
            
            if (cleanPhone.length < 10) {
                showErrorNotification('يرجى إدخال رقم هاتف صحيح (مثل: 966501234567)');
                return;
            }
            
            // Clear any existing countdown first
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            sendOTPBtn.disabled = true;
            sendOTPText.textContent = 'جاري الإرسال...';
            
            try {
                const response = await fetch('/api/send-otp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone: cleanPhone,
                        verification_type: 'company_registration'
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessNotification('تم إرسال رمز التحقق عبر واتساب');
                    document.getElementById('otpSection').classList.remove('hidden');
                    otpSessionId = result.session_id;
                    startCountdown(300);
                } else {
                    showErrorNotification(result.error || 'حدث خطأ في إرسال رمز التحقق');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorNotification('حدث خطأ في الاتصال بالخادم');
            } finally {
                sendOTPBtn.disabled = false;
                sendOTPText.textContent = 'إرسال رمز التحقق';
            }
        });

        // Verify OTP
        document.getElementById('verifyOTPBtn').addEventListener('click', async function() {
            const otpCode = document.getElementById('otpCode').value.trim();
            const verifyOTPBtn = document.getElementById('verifyOTPBtn');
            const verifyOTPText = document.getElementById('verifyOTPText');
            const otpStatus = document.getElementById('otpStatus');
            
            if (!otpCode || otpCode.length !== 6) {
                showErrorNotification('يرجى إدخال رمز التحقق المكون من 6 أرقام');
                return;
            }
            
            if (!otpSessionId) {
                showErrorNotification('يرجى إرسال رمز التحقق أولاً');
                return;
            }
            
            verifyOTPBtn.disabled = true;
            verifyOTPText.textContent = 'جاري التحقق...';
            
            try {
                const response = await fetch('/api/verify-otp/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: otpSessionId,
                        otp_code: otpCode
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    otpVerified = true;
                    otpStatus.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle ml-1"></i>تم التحقق بنجاح</span>';
                    verifyOTPBtn.disabled = true;
                    verifyOTPBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    verifyOTPText.textContent = 'تم التحقق';
                    
                    // Show admin account section
                    document.getElementById('adminAccountSection').classList.remove('hidden');
                    
                    showSuccessNotification('تم التحقق من رقم الهاتف بنجاح! يمكنك الآن إنشاء حساب المدير');
                } else {
                    otpStatus.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle ml-1"></i>رمز التحقق غير صحيح</span>';
                    showErrorNotification(result.error || 'رمز التحقق غير صحيح');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorNotification('حدث خطأ في الاتصال بالخادم');
            } finally {
                verifyOTPBtn.disabled = false;
                verifyOTPText.textContent = 'تحقق';
            }
        });

        // Countdown function
        function startCountdown(seconds) {
            // Clear any existing countdown first
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            const sendOTPBtn = document.getElementById('sendOTPBtn');
            const sendOTPText = document.getElementById('sendOTPText');
            
            let remaining = seconds;
            sendOTPBtn.disabled = true;
            
            countdownInterval = setInterval(() => {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                
                if (minutes > 0) {
                    sendOTPText.textContent = `إعادة إرسال (${minutes}:${secs.toString().padStart(2, '0')})`;
                } else {
                    sendOTPText.textContent = `إعادة إرسال (${secs} ثانية)`;
                }
                
                remaining--;
                
                if (remaining < 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    sendOTPBtn.disabled = false;
                    sendOTPText.textContent = 'إعادة إرسال';
                }
            }, 1000);
        }

        // Company registration form submission
        document.getElementById('companyRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!otpVerified) {
                showErrorNotification('يرجى التحقق من رقم الهاتف أولاً');
                return;
            }
            
            const submitBtn = document.getElementById('companySubmitBtn');
            const submitText = document.getElementById('companySubmitText');
            const loadingSpinner = document.getElementById('companyLoadingSpinner');
            
            submitBtn.disabled = true;
            submitText.textContent = 'جاري إنشاء الشركة...';
            loadingSpinner.classList.remove('hidden');
            
            try {
                const formData = new FormData(this);
                const companyPhone = formData.get('companyPhone');
                const cleanCompanyPhone = companyPhone ? companyPhone.replace(/[\+\s\-\(\)]/g, '') : '';
                
                // Validate admin password confirmation
                const adminPassword = formData.get('adminPassword');
                const adminPasswordConfirm = formData.get('adminPasswordConfirm');
                
                if (adminPassword !== adminPasswordConfirm) {
                    showErrorNotification('كلمة المرور وتأكيدها غير متطابقين');
                    return;
                }
                
                if (adminPassword.length < 6) {
                    showErrorNotification('كلمة المرور يجب أن تكون 6 أحرف على الأقل');
                    return;
                }

                const data = {
                    company: {
                        name: formData.get('companyName'),
                        code: formData.get('companyCode'),
                        phone: cleanCompanyPhone
                    },
                    admin: {
                        username: formData.get('adminUsername'),
                        password: adminPassword,
                        password_confirm: adminPasswordConfirm
                    },
                    otp_session_id: otpSessionId
                };
                
                const response = await fetch('/api/register-company/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    const adminUsername = result.admin?.username || 'غير محدد';
                    showSuccessNotification(`تم إنشاء الشركة وحساب المدير بنجاح! اسم المستخدم: ${adminUsername}`);
                    setTimeout(() => {
                        switchTab('login');
                    }, 3000);
                } else {
                    showErrorNotification(result.error || 'حدث خطأ في إنشاء الشركة');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorNotification('حدث خطأ في الاتصال بالخادم');
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = 'إنشاء الشركة';
                loadingSpinner.classList.add('hidden');
            }
        });

        // Staff registration form submission
        document.getElementById('staffRegistrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('staffSubmitBtn');
            const submitText = document.getElementById('staffSubmitText');
            const loadingSpinner = document.getElementById('staffLoadingSpinner');
            
            const password = document.getElementById('staffPassword').value;
            const passwordConfirm = document.getElementById('staffPasswordConfirm').value;
            
            if (password !== passwordConfirm) {
                showErrorNotification('كلمات المرور غير متطابقة');
                return;
            }
            
            submitBtn.disabled = true;
            submitText.textContent = 'جاري إضافة الموظف...';
            loadingSpinner.classList.remove('hidden');
            
            try {
                const formData = new FormData(this);
                const phone = formData.get('staffPhone');
                const cleanPhone = phone ? phone.replace(/[\+\s\-\(\)]/g, '') : '';
                
                const data = {
                    username: formData.get('staffUsername'),
                    email: formData.get('staffEmail'),
                    password: password,
                    phone: cleanPhone,
                    role: formData.get('staffRole')
                };
                
                const response = await fetch('/api/register-staff/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Token ' + localStorage.getItem('authToken')
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessNotification('تم إضافة الموظف بنجاح!');
                    setTimeout(() => {
                        window.location.href = '/dashboard/';
                    }, 1500);
                } else {
                    showErrorNotification(result.error || 'حدث خطأ في إضافة الموظف');
                }
            } catch (error) {
                console.error('Error:', error);
                showErrorNotification('حدث خطأ في الاتصال بالخادم');
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = 'إضافة الموظف';
                loadingSpinner.classList.add('hidden');
            }
        });

        // Load dark mode preference
        document.addEventListener('DOMContentLoaded', function() {
            // Clear any existing countdown on page load
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Reset OTP state
            otpVerified = false;
            otpSessionId = null;
            
            const darkMode = localStorage.getItem('darkMode');
            const icon = document.getElementById('darkModeIcon');
            
            if (darkMode === 'true') {
                document.documentElement.classList.add('dark');
                icon.className = 'fas fa-sun text-xl';
            }
            
            // Auto-focus on first input
            const firstInput = document.querySelector('input:not([type="hidden"])');
            if (firstInput) {
                firstInput.focus();
            }
        });
    </script>
</body>
</html>
