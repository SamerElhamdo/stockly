{% extends 'base.html' %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª - Stockly{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center m-4">
                <i class="fas fa-tags text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-primary font-cairo">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ¦Ø§Øª</h1>
                <p class="mt-2 text-secondary font-cairo">ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø§Øª</p>
            </div>
        </div>
        <button onclick="showAddCategoryModal()" class="btn-primary">
            <i class="fas fa-plus ml-2"></i>
            Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </button>
    </div>

    <!-- Categories Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div id="categoriesContainer">
            <div class="text-center text-muted py-12">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p class="mt-2 font-cairo">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 backdrop-blur-sm">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-primary rounded-xl shadow-2xl max-w-md w-full p-6 transform transition-all duration-300">
            <div class="flex items-center mb-6">
                <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center m-3">
                    <i class="fas fa-tag text-white"></i>
                </div>
                <h3 class="text-lg font-semibold text-primary font-cairo">Ø¥Ø¶Ø§ÙØ© ÙØ¦Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            </div>
            <form id="addCategoryForm">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary mb-2 font-cairo">Ø§Ø³Ù… Ø§Ù„ÙØ¦Ø© *</label>
                    <input id="categoryName" type="text" required
                           class="input-primary w-full">
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-secondary mb-2 font-cairo">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</label>
                    <div class="dropdown">
                        <div class="dropdown-toggle">
                            <span class="dropdown-text">Ø¨Ø¯ÙˆÙ† ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </div>
                        <div class="dropdown-menu">
                            <div class="dropdown-item selected" data-value="">Ø¨Ø¯ÙˆÙ† ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</div>
                        </div>
                        <input type="hidden" id="parentCategory" value="">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 space-x-reverse">
                    <button type="button" onclick="closeAddCategoryModal()" class="btn-secondary">
                        <i class="fas fa-times ml-2"></i>
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-check ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Load categories data
async function loadCategories() {
    try {
        const res = await fetch('/api/categories/', {
            headers: {
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            }
        });
        const categories = await res.json();
        
        const container = document.getElementById('categoriesContainer');
        if (categories.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center text-muted py-12 font-cairo">
                    <i class="fas fa-tags text-4xl mb-4 text-gray-400"></i>
                    <p class="mt-2 font-cairo">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = categories.map(category => `
            <div class="card card-hover m-4">
                <div class="flex items-center justify-between m-4">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center m-3">
                            <i class="fas fa-tag text-white"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-primary font-cairo">${category.name}</h3>
                            <p class="text-sm text-secondary font-cairo">${category.parent_name || 'ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©'}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2 space-x-reverse">
                        <button onclick="editCategory(${category.id})" class="btn-icon text-info hover:text-blue-800 dark:hover:text-blue-300">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteCategory(${category.id})" class="btn-icon text-danger hover:text-red-800 dark:hover:text-red-300">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-between text-sm text-secondary">
                    <span class="font-cairo">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${category.products_count || 0}</span>
                    <span class="font-cairo">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(category.created_at).toLocaleDateString('ar-SA')}</span>
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function showAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.remove('hidden');
    loadParentCategories();
}

function closeAddCategoryModal() {
    document.getElementById('addCategoryModal').classList.add('hidden');
    document.getElementById('addCategoryForm').reset();
}

async function loadParentCategories() {
    try {
        const res = await fetch('/api/categories/', {
            headers: {
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            }
        });
        const categories = await res.json();
        
        const dropdown = document.querySelector('#parentCategory').closest('.dropdown');
        const menu = dropdown.querySelector('.dropdown-menu');
        
        // Clear existing items except the default one
        menu.innerHTML = '<div class="dropdown-item selected" data-value="">Ø¨Ø¯ÙˆÙ† ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©</div>';
        
        categories.forEach(category => {
            const item = document.createElement('div');
            item.className = 'dropdown-item';
            item.dataset.value = category.id;
            item.textContent = category.name;
            menu.appendChild(item);
        });
    } catch (error) {
        console.error('Error loading parent categories:', error);
    }
}

async function addCategory(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('categoryName').value,
        parent: document.getElementById('parentCategory').value || null
    };
    
    try {
        const res = await fetch('/api/categories/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            },
            body: JSON.stringify(formData)
        });
        
        if (res.ok) {
            closeAddCategoryModal();
            loadCategories();
            showNotification('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        } else {
            showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©', 'error');
        }
    } catch (error) {
        console.error('Error adding category:', error);
        showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø©', 'error');
    }
}

function editCategory(categoryId) {
    // Implement edit functionality
    console.log('Editing category:', categoryId);
}

async function deleteCategory(categoryId) {
    const confirmed = await showConfirmation(
        'Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©',
        'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
        'Ø­Ø°Ù',
        'Ø¥Ù„ØºØ§Ø¡',
        'danger'
    );
    
    if (confirmed) {
        try {
            const res = await fetch(`/api/categories/${categoryId}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
                }
            });
            
            if (res.ok) {
                loadCategories();
                showNotification('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©', 'error');
            }
        } catch (error) {
            console.error('Error deleting category:', error);
            showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©', 'error');
        }
    }
}

// Use the global notification system from base.html

// Event listeners
document.getElementById('addCategoryForm').addEventListener('submit', addCategory);

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show loader while loading data
    PageLoader.show('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª...');
    
    Promise.all([
        loadCategories(),
        loadParentCategories()
    ]).then(() => {
        // Initialize custom dropdowns
        initDropdowns();
        // Hide loader after data is loaded
        PageLoader.hide();
    }).catch((error) => {
        console.error('Error loading data:', error);
        PageLoader.hide();
    });
});
</script>
{% endblock %}
