{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة المرتجعات - Stockly{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center">
            <div class="w-12 h-12 bg-gradient-to-r from-primary-500 to-primary-600 rounded-xl flex items-center justify-center m-4">
                <i class="fas fa-undo-alt text-white text-xl"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-primary font-cairo">إدارة المرتجعات</h1>
                <p class="mt-2 text-secondary font-cairo">إدارة مرتجعات العملاء وتحديث المخزون</p>
            </div>
        </div>
    </div>

    <!-- Action Button -->
    <div class="flex justify-end mb-6">
        <button onclick="showCreateReturnModal()" 
                class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center">
            <span class="text-xl mr-2">➕</span>
            إنشاء مرتجع جديد
        </button>
    </div>

    <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">إجمالي المرتجعات</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalReturns">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-undo-alt text-blue-600 dark:text-blue-400 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">في الانتظار</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="pendingReturns">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600 dark:text-yellow-400 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">موافق عليها</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="approvedReturns">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                <div class="flex items-center">
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">إجمالي المبلغ</p>
                        <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalAmount">0 $</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                        <i class="fas fa-dollar-sign text-purple-600 dark:text-purple-400 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 mb-6">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">فلترة المرتجعات</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">حالة المرتجع</label>
                        <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                            <option value="">جميع الحالات</option>
                            <option value="pending">في الانتظار</option>
                            <option value="approved">موافق عليه</option>
                            <option value="rejected">مرفوض</option>
                            <option value="completed">مكتمل</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">من تاريخ</label>
                        <input type="date" id="dateFromFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">إلى تاريخ</label>
                        <input type="date" id="dateToFilter" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">البحث</label>
                        <input type="text" id="searchFilter" placeholder="رقم المرتجع أو العميل" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    </div>
                </div>
                <div class="flex gap-3 mt-4">
                    <button onclick="applyFilters()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center">
                        <i class="fas fa-search ml-1"></i>
                        تطبيق الفلتر
                    </button>
                    <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center">
                        <i class="fas fa-times ml-1"></i>
                        مسح الفلتر
                    </button>
                </div>
            </div>
        </div>

        <!-- Returns Table -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">قائمة المرتجعات</h3>
                <button onclick="loadReturns()" class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center">
                    <i class="fas fa-sync-alt ml-1"></i>
                    تحديث
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم المرتجع</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الفاتورة الأصلية</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">العميل</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">المبلغ الإجمالي</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ المرتجع</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">أنشأ بواسطة</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="returnsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Create Return Modal -->
<div id="createReturnModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">إنشاء مرتجع جديد</h3>
            <button onclick="closeCreateReturnModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">الفاتورة الأصلية *</label>
                <div class="relative">
                    <input type="text" id="invoiceSearch" placeholder="ابحث عن الفاتورة بالرقم أو اسم العميل..." 
                           class="w-full px-3 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
                <div id="invoiceSearchResults" class="mt-2 max-h-60 overflow-y-auto border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 hidden">
                    <!-- Search results will be populated here -->
                </div>
                <input type="hidden" id="selectedInvoiceId" value="">
                <div id="selectedInvoiceInfo" class="mt-2 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-md hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="text-sm font-medium text-blue-900 dark:text-blue-100" id="selectedInvoiceText"></span>
                            <div class="text-xs text-blue-700 dark:text-blue-300" id="selectedInvoiceDetails"></div>
                        </div>
                        <button type="button" onclick="clearInvoiceSelection()" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ملاحظات</label>
                <textarea id="returnNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white"></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">العناصر المرتجعة *</label>
                <div id="invoiceItemsContainer" class="border border-gray-300 dark:border-gray-600 rounded-md p-4">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">يرجى اختيار الفاتورة أولاً</p>
                </div>
            </div>
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeCreateReturnModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                إلغاء
            </button>
            <button onclick="createReturn()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                إنشاء المرتجع
            </button>
        </div>
    </div>
</div>

<!-- Return Details Modal -->
<div id="returnDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-4/5 lg:w-3/4 xl:w-2/3 shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">تفاصيل المرتجع</h3>
            <button onclick="closeReturnDetailsModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="returnDetailsContent" class="space-y-6">
            <!-- Content will be loaded here -->
        </div>
        <div class="flex justify-end gap-3 mt-6">
            <button onclick="closeReturnDetailsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200">
                إغلاق
            </button>
            <div id="returnActions">
                <!-- Action buttons will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let returnsData = [];
let invoices = [];
let searchTimeout; // Move searchTimeout to global scope

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadReturns();
    loadInvoices();
    
    // Check for customer parameter in URL
    checkCustomerParameter();
    
    // Add search event listener
    const invoiceSearchElement = document.getElementById('invoiceSearch');
    if (invoiceSearchElement) {
        invoiceSearchElement.addEventListener('input', function(e) {
            searchInvoices(e.target.value);
        });
    }
    
    // Hide search results when clicking outside
    document.addEventListener('click', function(e) {
        const searchContainer = document.getElementById('invoiceSearch')?.closest('div');
        if (searchContainer && !searchContainer.contains(e.target)) {
            document.getElementById('invoiceSearchResults')?.classList.add('hidden');
        }
    });
});

// Check for customer parameter and load their invoices
async function checkCustomerParameter() {
    const urlParams = new URLSearchParams(window.location.search);
    const customerId = urlParams.get('customer');
    
    if (customerId) {
        try {
            // Load customer invoices
            const response = await fetch(`/api/customers/${customerId}/invoices/`, {
                headers: {
                    'Authorization': 'Token ' + localStorage.getItem('authToken')
                }
            });
            
            if (response.ok) {
                const invoices = await response.json();
                
                if (invoices.length > 0) {
                    // Get customer name for display
                    const customerName = invoices[0].customer_name;
                    
                    // Display invoices
                    displayInvoiceSearchResults(invoices);
                    
                    // Show search results
                    document.getElementById('invoiceSearchResults').classList.remove('hidden');
                    
                    // Add a note about the filtered customer
                    const resultsContainer = document.getElementById('invoiceSearchResults');
                    const note = document.createElement('div');
                    note.className = 'p-2 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 text-xs border-b border-blue-200 dark:border-blue-700';
                    note.innerHTML = `<i class="fas fa-info-circle mr-1"></i>عرض فواتير العميل: ${customerName}`;
                    resultsContainer.insertBefore(note, resultsContainer.firstChild);
                    
                    // Auto-open create return modal
                    setTimeout(() => {
                        showCreateReturnModal();
                        
                        // Add customer info to modal
                        const modal = document.getElementById('createReturnModal');
                        if (modal) {
                            const existingNote = modal.querySelector('.customer-note');
                            if (!existingNote) {
                                const note = document.createElement('div');
                                note.className = 'customer-note p-3 bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 text-sm rounded-md mb-4';
                                note.innerHTML = `<i class="fas fa-user mr-2"></i>إنشاء مرتجع للعميل: ${customerName}`;
                                const form = modal.querySelector('.space-y-4');
                                if (form) {
                                    form.insertBefore(note, form.firstChild);
                                }
                            }
                        }
                    }, 500); // Small delay to ensure modal is ready
                    
                } else {
                    // No invoices found for this customer
                    const resultsContainer = document.getElementById('invoiceSearchResults');
                    resultsContainer.innerHTML = '<div class="p-3 text-center text-gray-500 dark:text-gray-400">لا توجد فواتير مؤكدة لهذا العميل</div>';
                    resultsContainer.classList.remove('hidden');
                    
                    // Still show the modal but with a message
                    setTimeout(() => {
                        showCreateReturnModal();
                        // Show a message in the modal
                        const modal = document.getElementById('createReturnModal');
                        if (modal) {
                            const existingNote = modal.querySelector('.customer-note');
                            if (!existingNote) {
                                const note = document.createElement('div');
                                note.className = 'customer-note p-3 bg-yellow-50 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-200 text-sm rounded-md mb-4';
                                note.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i>لا توجد فواتير مؤكدة لهذا العميل لإنشاء مرتجع';
                                const form = modal.querySelector('.space-y-4');
                                if (form) {
                                    form.insertBefore(note, form.firstChild);
                                }
                            }
                        }
                    }, 500);
                }
            }
        } catch (error) {
            console.error('Error loading customer invoices:', error);
        }
    }
}

// Load returns data
async function loadReturns() {
    try {
        const response = await fetch('/api/returns/', {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (response.ok) {
            returnsData = await response.json();
            displayReturns(returnsData);
            updateStats();
        } else {
            // Only show error if it's not a 404 (no returns found)
            if (response.status !== 404) {
                showNotification('خطأ في تحميل المرتجعات', 'error');
            }
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    }
}

// Display returns in table
function displayReturns(returns) {
    const tbody = document.getElementById('returnsTableBody');
    tbody.innerHTML = '';
    
    if (returns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">لا توجد مرتجعات</td></tr>';
        return;
    }
    
    returns.forEach(returnItem => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${returnItem.return_number}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${returnItem.original_invoice}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${returnItem.customer_name}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(returnItem.status)}">
                    ${returnItem.status_display}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${returnItem.total_amount.toFixed(2)} $</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatDate(returnItem.return_date)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${returnItem.created_by}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex gap-2">
                    <button onclick="viewReturnDetails(${returnItem.id})" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${returnItem.status === 'pending' ? `
                        <button onclick="approveReturn(${returnItem.id})" class="text-green-600 hover:text-green-900 dark:text-green-400 dark:hover:text-green-300">
                            <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectReturn(${returnItem.id})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                            <i class="fas fa-times"></i>
                        </button>
                    ` : ''}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Get status badge class
function getStatusBadgeClass(status) {
    switch(status) {
        case 'pending': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300';
        case 'approved': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300';
        case 'rejected': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300';
        case 'completed': return 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300';
        default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300';
    }
}

// Update statistics
function updateStats() {
    const total = returnsData.length;
    const pending = returnsData.filter(r => r.status === 'pending').length;
    const approved = returnsData.filter(r => r.status === 'approved').length;
    const totalAmount = returnsData.reduce((sum, r) => sum + r.total_amount, 0);
    
    document.getElementById('totalReturns').textContent = total;
    document.getElementById('pendingReturns').textContent = pending;
    document.getElementById('approvedReturns').textContent = approved;
    document.getElementById('totalAmount').textContent = totalAmount.toFixed(2) + ' $';
}


// Load invoices (no longer needed as we use search)
async function loadInvoices() {
    // This function is kept for compatibility but no longer needed
    // as we use the search system instead of a dropdown
}

// Show create return modal
function showCreateReturnModal() {
    document.getElementById('createReturnModal').classList.remove('hidden');
}

// Close create return modal
function closeCreateReturnModal() {
    document.getElementById('createReturnModal').classList.add('hidden');
    
    // Reset form elements safely
    const invoiceSearch = document.getElementById('invoiceSearch');
    const returnNotes = document.getElementById('returnNotes');
    const selectedInvoiceInfo = document.getElementById('selectedInvoiceInfo');
    const invoiceSearchResults = document.getElementById('invoiceSearchResults');
    const invoiceItemsContainer = document.getElementById('invoiceItemsContainer');
    
    if (invoiceSearch) invoiceSearch.value = '';
    if (returnNotes) returnNotes.value = '';
    if (selectedInvoiceInfo) selectedInvoiceInfo.classList.add('hidden');
    if (invoiceSearchResults) invoiceSearchResults.classList.add('hidden');
    if (invoiceItemsContainer) invoiceItemsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">يرجى اختيار الفاتورة أولاً</p>';
    
    // Clear selected invoice
    document.getElementById('selectedInvoiceId').value = '';
}

// This event listener is no longer needed as we use the new search system

// Display returnable items
function displayReturnableItems(items) {
    const container = document.getElementById('returnableItems');
    
    if (items.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">لا توجد عناصر قابلة للإرجاع في هذه الفاتورة</p>';
        return;
    }
    
    let html = '<div class="space-y-3">';
    
    items.forEach(item => {
        html += `
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">${item.product_name}</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400">SKU: ${item.product_sku}</p>
                    <div class="flex gap-4 text-xs text-gray-600 dark:text-gray-400 mt-1">
                        <span>مباع: ${item.qty_sold}</span>
                        <span>مرتجع: ${item.qty_returned}</span>
                        <span>متاح: ${item.qty_available}</span>
                        <span>السعر: ${item.unit_price.toFixed(2)} $</span>
                    </div>
                </div>
                <div class="w-24">
                    <input type="number" class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-gray-800 dark:text-white return-qty" 
                           data-item-id="${item.id}" 
                           data-max-qty="${item.qty_available}"
                           min="0" max="${item.qty_available}" 
                           step="0.01" value="0">
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Search invoices
async function searchInvoices(query) {
    if (query.length < 2) {
        document.getElementById('invoiceSearchResults').classList.add('hidden');
        return;
    }
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`/api/search-invoices/?q=${encodeURIComponent(query)}`, {
                headers: {
                    'Authorization': 'Token ' + localStorage.getItem('authToken')
                }
            });
            
            if (response.ok) {
                const invoices = await response.json();
                displayInvoiceSearchResults(invoices);
            } else {
                showNotification('خطأ في البحث عن الفواتير', 'error');
            }
        } catch (error) {
            console.error('Error searching invoices:', error);
            showNotification('خطأ في الاتصال بالخادم', 'error');
        }
    }, 300);
}

// Display search results
function displayInvoiceSearchResults(invoices) {
    const resultsContainer = document.getElementById('invoiceSearchResults');
    
    if (invoices.length === 0) {
        resultsContainer.innerHTML = '<div class="p-3 text-center text-gray-500 dark:text-gray-400">لا توجد فواتير</div>';
    } else {
        let html = '';
        invoices.forEach(invoice => {
            html += `
                <div class="p-3 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer border-b border-gray-200 dark:border-gray-600 last:border-b-0" 
                     onclick="selectInvoice(${invoice.id}, '${invoice.invoice_number}', '${invoice.customer_name}', ${invoice.total_amount}, '${invoice.created_at}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-medium text-gray-900 dark:text-white">${invoice.invoice_number}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">العميل: ${invoice.customer_name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-500">${invoice.created_at}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium text-gray-900 dark:text-white">${invoice.total_amount.toFixed(2)} $</div>
                            <div class="text-xs text-green-600 dark:text-green-400">${invoice.status_display}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        resultsContainer.innerHTML = html;
    }
    
    resultsContainer.classList.remove('hidden');
}

// Select invoice
function selectInvoice(invoiceId, invoiceNumber, customerName, totalAmount, createdAt) {
    document.getElementById('selectedInvoiceId').value = invoiceId;
    document.getElementById('selectedInvoiceText').textContent = `${invoiceNumber} - ${customerName}`;
    document.getElementById('selectedInvoiceDetails').textContent = `المبلغ: ${totalAmount.toFixed(2)} $ | التاريخ: ${createdAt}`;
    
    document.getElementById('selectedInvoiceInfo').classList.remove('hidden');
    document.getElementById('invoiceSearchResults').classList.add('hidden');
    document.getElementById('invoiceSearch').value = '';
    
    // Load invoice items
    loadInvoiceItems(invoiceId);
}

// Clear invoice selection
function clearInvoiceSelection() {
    document.getElementById('selectedInvoiceId').value = '';
    document.getElementById('selectedInvoiceInfo').classList.add('hidden');
    document.getElementById('invoiceSearch').value = '';
    document.getElementById('invoiceItemsContainer').innerHTML = '';
}

// Load invoice items for return
async function loadInvoiceItems(invoiceId) {
    try {
        const response = await fetch(`/api/invoices/${invoiceId}/returnable-items/`, {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (response.ok) {
            const items = await response.json();
            displayInvoiceItems(items, 'invoiceItemsContainer');
        } else {
            showNotification('خطأ في تحميل عناصر الفاتورة', 'error');
        }
    } catch (error) {
        console.error('Error loading invoice items:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    }
}

// Display invoice items for return
function displayInvoiceItems(items, containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    if (items.length === 0) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">لا توجد عناصر قابلة للاسترجاع في هذه الفاتورة</p>';
        return;
    }
    
    let html = '<div class="space-y-3">';
    
    items.forEach(item => {
        html += `
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white">${item.product_name}</h4>
                    <p class="text-xs text-gray-500 dark:text-gray-400">SKU: ${item.product_sku}</p>
                    <div class="flex gap-4 text-xs text-gray-600 dark:text-gray-400 mt-1">
                        <span>مباع: ${item.qty_sold}</span>
                        <span>مرتجع: ${item.qty_returned}</span>
                        <span>متاح: ${item.qty_available}</span>
                        <span>السعر: ${item.unit_price.toFixed(2)} $</span>
                    </div>
                </div>
                <div class="w-24">
                    <input type="number" class="w-full px-2 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-gray-800 dark:text-white return-qty" 
                           data-item-id="${item.id}" 
                           data-max-qty="${item.qty_available}"
                           min="0" max="${item.qty_available}" 
                           step="0.01" value="0">
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Create return
async function createReturn() {
    const invoiceId = document.getElementById('selectedInvoiceId').value;
    const notes = document.getElementById('returnNotes').value;
    
    if (!invoiceId) {
        showNotification('يرجى اختيار الفاتورة', 'error');
        return;
    }
    
    // Collect return items
    const returnItems = [];
    const qtyInputs = document.querySelectorAll('.return-qty');
    
    qtyInputs.forEach(input => {
        const qty = parseFloat(input.value);
        if (qty > 0) {
            returnItems.push({
                original_item_id: input.dataset.itemId,
                qty_returned: qty
            });
        }
    });
    
    if (returnItems.length === 0) {
        showNotification('يرجى تحديد كمية مرتجعة لصنف واحد على الأقل', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/returns/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({
                invoice_id: invoiceId,
                notes: notes,
                items: returnItems
            })
        });
        
        if (response.ok) {
            showNotification('تم إنشاء المرتجع بنجاح', 'success');
            closeCreateReturnModal();
            // Load returns without showing error if it fails
            try {
                await loadReturns();
            } catch (loadError) {
                console.error('Error loading returns after creation:', loadError);
                // Don't show error notification for this
            }
        } else {
            const error = await response.json();
            showNotification(error.error || 'خطأ في إنشاء المرتجع', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    }
}

// View return details
async function viewReturnDetails(returnId) {
    try {
        const response = await fetch(`/api/returns/${returnId}/`, {
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (response.ok) {
            const returnData = await response.json();
            displayReturnDetails(returnData);
            document.getElementById('returnDetailsModal').classList.remove('hidden');
        } else {
            showNotification('خطأ في تحميل تفاصيل المرتجع', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    }
}

// Display return details
function displayReturnDetails(returnData) {
    const content = document.getElementById('returnDetailsContent');
    const actions = document.getElementById('returnActions');
    
    content.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">معلومات المرتجع</h4>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">رقم المرتجع:</span>
                        <span class="text-sm text-gray-900 dark:text-white">${returnData.return_number}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">الفاتورة الأصلية:</span>
                        <span class="text-sm text-gray-900 dark:text-white">${returnData.original_invoice}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">العميل:</span>
                        <span class="text-sm text-gray-900 dark:text-white">${returnData.customer_name}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">الحالة:</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(returnData.status)}">
                            ${returnData.status_display}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">المبلغ الإجمالي:</span>
                        <span class="text-sm text-gray-900 dark:text-white">${returnData.total_amount.toFixed(2)} $</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">تاريخ المرتجع:</span>
                        <span class="text-sm text-gray-900 dark:text-white">${formatDate(returnData.return_date)}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm font-medium text-gray-500 dark:text-gray-400">الملاحظات:</span>
                        <span class="text-sm text-gray-900 dark:text-white">${returnData.notes || 'لا توجد ملاحظات'}</span>
                    </div>
                </div>
            </div>
            <div>
                <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">العناصر المرتجعة</h4>
                <div class="space-y-3">
                    ${returnData.items.map(item => `
                        <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <div>
                                <h5 class="text-sm font-medium text-gray-900 dark:text-white">${item.product_name}</h5>
                                <p class="text-xs text-gray-500 dark:text-gray-400">SKU: ${item.product_sku}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm text-gray-900 dark:text-white">${item.qty_returned} × ${item.unit_price.toFixed(2)}</p>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">${item.line_total.toFixed(2)} $</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    // Action buttons
    if (returnData.status === 'pending') {
        actions.innerHTML = `
            <button onclick="approveReturn(${returnData.id})" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center">
                <i class="fas fa-check ml-1"></i>
                موافقة
            </button>
            <button onclick="rejectReturn(${returnData.id})" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 flex items-center">
                <i class="fas fa-times ml-1"></i>
                رفض
            </button>
        `;
    } else {
        actions.innerHTML = '';
    }
}

// Close return details modal
function closeReturnDetailsModal() {
    document.getElementById('returnDetailsModal').classList.add('hidden');
}

// Approve return
async function approveReturn(returnId) {
    const confirmed = await showConfirmation(
        'الموافقة على المرتجع',
        'هل أنت متأكد من الموافقة على هذا المرتجع؟ لا يمكن التراجع عن هذا الإجراء.',
        'موافقة',
        'إلغاء',
        'success'
    );
    
    if (!confirmed) {
        return;
    }
    
    try {
        const response = await fetch(`/api/returns/${returnId}/approve/`, {
            method: 'POST',
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (response.ok) {
            showNotification('تم الموافقة على المرتجع بنجاح', 'success');
            closeReturnDetailsModal();
            // Load returns without showing error if it fails
            try {
                await loadReturns();
            } catch (loadError) {
                console.error('Error loading returns after approval:', loadError);
                // Don't show error notification for this
            }
        } else {
            const error = await response.json();
            showNotification(error.error || 'خطأ في الموافقة على المرتجع', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    }
}

// Reject return
async function rejectReturn(returnId) {
    const confirmed = await showConfirmation(
        'رفض المرتجع',
        'هل أنت متأكد من رفض هذا المرتجع؟ لا يمكن التراجع عن هذا الإجراء.',
        'رفض',
        'إلغاء',
        'danger'
    );
    
    if (!confirmed) {
        return;
    }
    
    try {
        const response = await fetch(`/api/returns/${returnId}/reject/`, {
            method: 'POST',
            headers: {
                'Authorization': 'Token ' + localStorage.getItem('authToken')
            }
        });
        
        if (response.ok) {
            showNotification('تم رفض المرتجع', 'success');
            closeReturnDetailsModal();
            // Load returns without showing error if it fails
            try {
                await loadReturns();
            } catch (loadError) {
                console.error('Error loading returns after rejection:', loadError);
                // Don't show error notification for this
            }
        } else {
            const error = await response.json();
            showNotification(error.error || 'خطأ في رفض المرتجع', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('خطأ في الاتصال بالخادم', 'error');
    }
}

// Utility functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-GB');
}

// Notification system
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
    
    // Set colors based on type
    if (type === 'success') {
        notification.className += ' bg-green-500 text-white';
    } else if (type === 'error') {
        notification.className += ' bg-red-500 text-white';
    } else if (type === 'warning') {
        notification.className += ' bg-yellow-500 text-white';
    } else {
        notification.className += ' bg-blue-500 text-white';
    }
    
    notification.innerHTML = `
        <div class="flex items-center">
            <span class="mr-2">
                ${type === 'success' ? '✓' : type === 'error' ? '✗' : type === 'warning' ? '⚠' : 'ℹ'}
            </span>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 300);
    }, 5000);
}


// Filter functions
function applyFilters() {
    // Implement filtering logic here
    console.log('Applying filters...');
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    document.getElementById('searchFilter').value = '';
    loadReturns();
}
</script>
{% endblock %}