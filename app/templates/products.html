{% extends 'base.html' %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª - Stockly{% endblock %}

<style>
/* Custom styles for the modal */
#addProductModal .modal-content {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e1 #f1f5f9;
}

#addProductModal .modal-content::-webkit-scrollbar {
    width: 6px;
}

#addProductModal .modal-content::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

#addProductModal .modal-content::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

#addProductModal .modal-content::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

.dark #addProductModal .modal-content::-webkit-scrollbar-track {
    background: #374151;
}

.dark #addProductModal .modal-content::-webkit-scrollbar-thumb {
    background: #6b7280;
}

.dark #addProductModal .modal-content::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

/* Smooth scrolling */
#addProductModal .modal-content {
    scroll-behavior: smooth;
}
</style>

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white">   Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
            <p class="mt-2 text-gray-600 dark:text-gray-400">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
        </div>
        <button onclick="showAddProductModal()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center">
            <span class="text-xl mr-2">â•</span>
            Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
        </button>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6 border border-gray-200 dark:border-gray-700">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <input id="searchInput" type="text" placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ SKU..."
                       class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
            </div>
            <select id="categoryFilter" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
            </select>
            <button onclick="searchProducts()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg">
                <i class="fas fa-search ml-2"></i>Ø¨Ø­Ø«
            </button>
            <button onclick="clearSearch()" id="clearSearchBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg">
                <i class="fas fa-times ml-2"></i>Ù…Ø³Ø­
            </button>
        </div>
    </div>

    <!-- Low Stock Alert -->
    <div id="lowStockAlert" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <span class="text-red-400 text-xl">âš ï¸</span>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800 dark:text-red-400">ØªÙ†Ø¨ÙŠÙ‡: Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶</h3>
                <div class="mt-2 text-sm text-red-700 dark:text-red-300">
                    <p id="lowStockMessage">ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø¨ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow border border-gray-200 dark:border-gray-700">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø§Ù„Ø§Ø³Ù…</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">SKU</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø§Ù„ÙØ¦Ø©</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø§Ù„ÙˆØ­Ø¯Ø©</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø§Ù„Ù‚ÙŠØ§Ø³</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø§Ù„Ø³Ø¹Ø±</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">QR Code</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <tr>
                        <td colspan="9" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                            <span class="text-4xl">ğŸ“¦</span>
                            <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="p-6 flex-1 overflow-y-auto modal-content">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</h3>
                    <button type="button" onclick="closeAddProductModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="addProductForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ø§Ø³Ù… *</label>
                    <input id="productName" type="text" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">SKU (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="productSku" type="text" placeholder="Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·"
                           pattern="[A-Za-z0-9]*" 
                           oninput="this.value = this.value.replace(/[^A-Za-z0-9]/g, '')"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· - Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² ÙØ±ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ÙØ¦Ø© *</label>
                    <select id="productCategory" required
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ø³Ø¹Ø± *</label>
                    <input id="productPrice" type="number" step="0.01" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ÙˆØ­Ø¯Ø©</label>
                    <select id="productUnit"
                            class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                        <option value="piece">Ø¹Ø¯Ø¯</option>
                        <option value="meter">Ù…ØªØ±</option>
                        <option value="kg">ÙƒÙŠÙ„Ùˆ</option>
                        <option value="liter">Ù„ØªØ±</option>
                        <option value="box">ØµÙ†Ø¯ÙˆÙ‚</option>
                        <option value="pack">Ø¹Ø¨ÙˆØ©</option>
                        <option value="roll">Ù„ÙØ©</option>
                        <option value="sheet">ÙˆØ±Ù‚Ø©</option>
                        <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="productMeasurement" type="text" placeholder="Ù…Ø«Ø§Ù„: 50x30 Ø³Ù…"
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <textarea id="productDescription" rows="3" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙØ§Ù‹ Ù…ÙØµÙ„Ø§Ù‹ Ù„Ù„Ù…Ù†ØªØ¬..."
                              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white resize-none"></textarea>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                    <input id="productStock" type="number" required
                           class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                </div>
                </form>
            </div>
            <!-- Fixed footer with buttons -->
            <div class="sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 rounded-b-lg">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddProductModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                        Ø¥Ù„ØºØ§Ø¡
                    </button>
                    <button type="submit" form="addProductForm" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md">
                        Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Load products data
async function loadProducts() {
    try {
        const res = await fetch('/api/products/', {
            headers: {
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            }
        });
        const products = await res.json();
        
        // Store products globally for QR generation
        window.currentProducts = products;
        
        const tbody = document.getElementById('productsTableBody');
        if (products.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-box text-4xl mb-4 text-gray-400"></i>
                        <p class="mt-2 font-cairo">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = products.map(product => `
            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900 dark:text-white product-name">${product.name}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-600 dark:text-gray-400 font-mono product-sku">${product.sku}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-600 dark:text-gray-400 product-category">${product.category_name || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        ${product.unit_display || '-'}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-600 dark:text-gray-400">${product.measurement || '-'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">${product.price.toLocaleString()} $</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        product.stock_qty < 5 ? 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400' : 
                        product.stock_qty < 20 ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400' : 
                        'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400'
                    }">
                        ${product.stock_qty}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <button onclick="generateQR(${product.id})" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300">
                        <i class="fas fa-qrcode ml-1"></i>QR
                    </button>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="editProduct(${product.id})" class="text-yellow-600 hover:text-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-300 mr-3">
                        <i class="fas fa-edit ml-1"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                    <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">
                        <i class="fas fa-trash ml-1"></i>Ø­Ø°Ù
                    </button>
                </td>
            </tr>
        `).join('');
        
        // Check for low stock
        checkLowStock(products);
        
        // Apply any existing search filters after loading
        setTimeout(() => {
            searchProducts();
        }, 100);
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// Load categories for filter and form
async function loadCategories() {
    try {
        const res = await fetch('/api/categories/', {
            headers: {
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            }
        });
        const categories = await res.json();
        
        const categoryFilter = document.getElementById('categoryFilter');
        const productCategory = document.getElementById('productCategory');
        
        categories.forEach(category => {
            const option1 = new Option(category.name, category.name);
            const option2 = new Option(category.name, category.id);
            categoryFilter.add(option1);
            productCategory.add(option2);
        });
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function checkLowStock(products) {
    const lowStockProducts = products.filter(p => p.stock_qty < 5);
    const alert = document.getElementById('lowStockAlert');
    const message = document.getElementById('lowStockMessage');
    
    if (lowStockProducts.length > 0) {
        alert.classList.remove('hidden');
        message.textContent = `ÙŠÙˆØ¬Ø¯ ${lowStockProducts.length} Ù…Ù†ØªØ¬ Ø¨ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©: ${lowStockProducts.map(p => p.name).join(', ')}`;
    } else {
        alert.classList.add('hidden');
    }
}

function showAddProductModal() {
    document.getElementById('addProductModal').classList.remove('hidden');
}

function closeAddProductModal() {
    document.getElementById('addProductModal').classList.add('hidden');
    document.getElementById('addProductForm').reset();
}

async function addProduct(event) {
    event.preventDefault();
    
    const formData = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        price: parseFloat(document.getElementById('productPrice').value),
        stock_qty: parseInt(document.getElementById('productStock').value),
        unit: document.getElementById('productUnit').value,
        measurement: document.getElementById('productMeasurement').value,
        description: document.getElementById('productDescription').value
    };
    
    // Add SKU only if provided and valid
    const skuValue = document.getElementById('productSku').value.trim();
    if (skuValue) {
        // Validate SKU contains only English letters and numbers
        if (!/^[A-Za-z0-9]+$/.test(skuValue)) {
            showNotification('âŒ SKU ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·', 'error');
            return;
        }
        formData.sku = skuValue;
    }
    
    try {
        // Show loader with progress
        PageLoader.show('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬...');
        
        const res = await fetch('/api/products/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            },
            body: JSON.stringify(formData)
        });
        
        if (res.ok) {
            PageLoader.setText('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
            setTimeout(() => {
                closeAddProductModal();
                loadProducts();
                PageLoader.hide();
                showNotification('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }, 500);
        } else {
            const error = await res.json();
            PageLoader.hide();
            
            if (error.error === 'invalid_sku_format') {
                showNotification('âŒ SKU ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø­Ø±Ù Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·', 'error');
            } else {
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬', 'error');
            }
        }
    } catch (error) {
        console.error('Error adding product:', error);
        PageLoader.hide();
        showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬', 'error');
    }
}

function searchProducts() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const category = document.getElementById('categoryFilter').value;
    
    // Get all product rows (excluding the loading/no products row)
    const productRows = document.querySelectorAll('#productsTableBody tr:not([colspan])');
    
    // If no products loaded yet, return
    if (productRows.length === 0) {
        return;
    }
    
    let visibleCount = 0;
    
    productRows.forEach(row => {
        // Skip if this is a message row
        if (row.querySelector('[colspan]')) {
            return;
        }
        
        const productName = row.querySelector('.product-name')?.textContent.toLowerCase() || '';
        const productCategory = row.querySelector('.product-category')?.textContent.toLowerCase() || '';
        const productSku = row.querySelector('.product-sku')?.textContent.toLowerCase() || '';
        
        // Check if row matches search criteria
        const matchesQuery = !query || productName.includes(query) || productSku.includes(query);
        const matchesCategory = !category || productCategory === category.toLowerCase() || productCategory.includes(category.toLowerCase());
        
        if (matchesQuery && matchesCategory) {
            row.style.display = '';
            row.classList.remove('hidden');
            visibleCount++;
        } else {
            row.style.display = 'none';
            row.classList.add('hidden');
        }
    });
    
    // Show/hide no results message
    const noResultsMessage = document.getElementById('noResultsMessage');
    
    if (visibleCount === 0 && (query || category)) {
        if (!noResultsMessage) {
            const tbody = document.getElementById('productsTableBody');
            tbody.insertAdjacentHTML('afterend', `
                <tr id="noResultsMessage" class="bg-gray-50 dark:bg-gray-700">
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                        <i class="fas fa-search text-4xl mb-4 text-gray-400"></i>
                        <p class="mt-2 font-cairo">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</p>
                        <p class="text-sm mt-1">Ø¬Ø±Ø¨ ØªØºÙŠÙŠØ± Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø«</p>
                    </td>
                </tr>
            `);
        }
    } else if (noResultsMessage) {
        noResultsMessage.remove();
    }
}

async function editProduct(productId) {
    try {
        // Store the product ID for later use
        window.currentEditingProductId = productId;
        
        // Get product data first
        const res = await fetch(`/api/products/`, {
            headers: {
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            }
        });
        const products = await res.json();
        const product = products.find(p => p.id === productId);
        
        if (!product) {
            showErrorNotification('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        // Show edit modal
        showEditProductModal(product);
    } catch (error) {
        console.error('Error loading product:', error);
        showErrorNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬');
    }
}

function showEditProductModal(product) {
    // Create modal HTML
    const modalHtml = `
        <div id="editProductModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50 backdrop-blur-sm">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto flex flex-col">
                    <div class="p-6 flex-1 overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white font-cairo">
                                <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬
                            </h3>
                            <button onclick="closeEditProductModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <form id="editProductForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-tag ml-2"></i>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ *
                                </label>
                                <input type="text" id="editProductName" value="${product.name}" required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-list ml-2"></i>Ø§Ù„ÙØ¦Ø© *
                                </label>
                                <select id="editProductCategory" required
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-dollar-sign ml-2"></i>Ø§Ù„Ø³Ø¹Ø± *
                                </label>
                                <input type="number" id="editProductPrice" value="${product.price}" step="0.01" required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-cube ml-2"></i>Ø§Ù„ÙˆØ­Ø¯Ø©
                                </label>
                                <select id="editProductUnit"
                                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                                    <option value="piece">Ø¹Ø¯Ø¯</option>
                                    <option value="meter">Ù…ØªØ±</option>
                                    <option value="kg">ÙƒÙŠÙ„Ùˆ</option>
                                    <option value="liter">Ù„ØªØ±</option>
                                    <option value="box">ØµÙ†Ø¯ÙˆÙ‚</option>
                                    <option value="pack">Ø¹Ø¨ÙˆØ©</option>
                                    <option value="roll">Ù„ÙØ©</option>
                                    <option value="sheet">ÙˆØ±Ù‚Ø©</option>
                                    <option value="other">Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-ruler ml-2"></i>Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                </label>
                                <input type="text" id="editProductMeasurement" value="${product.measurement || ''}" 
                                       placeholder="Ù…Ø«Ø§Ù„: 50x30 Ø³Ù…"
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-align-right ml-2"></i>ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                                </label>
                                <textarea id="editProductDescription" rows="3" placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙØ§Ù‹ Ù…ÙØµÙ„Ø§Ù‹ Ù„Ù„Ù…Ù†ØªØ¬..."
                                          class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white resize-none">${product.description || ''}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    <i class="fas fa-boxes ml-2"></i>Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† *
                                </label>
                                <input type="number" id="editProductStock" value="${product.stock_qty}" required
                                       class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-700 dark:text-white">
                            </div>
                        </form>
                    </div>
                    
                    <!-- Fixed footer with buttons -->
                    <div class="sticky bottom-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 rounded-b-lg">
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeEditProductModal()" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                                <i class="fas fa-times ml-2"></i>
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button type="submit" form="editProductForm" class="px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-md">
                                <i class="fas fa-save ml-2"></i>
                                Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Load categories
    loadCategoriesForEdit();
    
    // Set current values
    setTimeout(() => {
        // Set category
        if (product.category_id) {
            document.getElementById('editProductCategory').value = product.category_id;
        }
        
        // Set unit
        if (product.unit) {
            document.getElementById('editProductUnit').value = product.unit;
        }
    }, 100);
    
    // Show modal
    document.getElementById('editProductModal').classList.remove('hidden');
}

async function loadCategoriesForEdit() {
    try {
        const res = await fetch('/api/categories/', {
            headers: {
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            }
        });
        const categories = await res.json();
        
        const select = document.getElementById('editProductCategory');
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©</option>' + 
            categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function closeEditProductModal() {
    const modal = document.getElementById('editProductModal');
    if (modal) {
        modal.remove();
    }
}

// Handle edit form submission
document.addEventListener('submit', function(e) {
    if (e.target.id === 'editProductForm') {
        e.preventDefault();
        updateProduct();
    }
});

async function updateProduct() {
    const productData = {
        name: document.getElementById('editProductName').value,
        category: document.getElementById('editProductCategory').value,
        price: parseFloat(document.getElementById('editProductPrice').value),
        stock_qty: parseInt(document.getElementById('editProductStock').value),
        unit: document.getElementById('editProductUnit').value,
        measurement: document.getElementById('editProductMeasurement').value,
        description: document.getElementById('editProductDescription').value
    };
    
    try {
        // Get product ID from the current product being edited
        const productId = window.currentEditingProductId;
        
        // Show loader
        PageLoader.show('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬...');
        
        const res = await fetch(`/api/products/${productId}/update/`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
            },
            body: JSON.stringify(productData)
        });
        
        if (res.ok) {
            PageLoader.setText('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­!');
            setTimeout(() => {
                closeEditProductModal();
                loadProducts(); // Reload products list
                PageLoader.hide();
                showNotification('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }, 500);
        } else {
            const error = await res.json();
            PageLoader.hide();
            showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬: ' + (error.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'), 'error');
        }
    } catch (error) {
        console.error('Error updating product:', error);
        PageLoader.hide();
        showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬', 'error');
    }
}

function generateQR(productId) {
    console.log('Generating QR for product ID:', productId);
    
    // Check if QR Code library is loaded
    if (typeof qrcode === 'undefined') {
        console.error('QRCode library not loaded');
        showNotification('Ù…ÙƒØªØ¨Ø© QR Code ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.', 'error');
        return;
    }
    
    // Find product data from the current products list
    const product = window.currentProducts?.find(p => p.id === productId);
    if (product) {
        console.log('Product found:', product);
        generateQRCode(productId, product.name, product.sku);
    } else {
        console.error('Product not found for ID:', productId);
        showNotification('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬', 'error');
    }
}

async function deleteProduct(productId) {
    const confirmed = await showConfirmation(
        'Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬',
        'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.',
        'Ø­Ø°Ù',
        'Ø¥Ù„ØºØ§Ø¡',
        'danger'
    );
    
    if (confirmed) {
        try {
            const res = await fetch(`/api/products/${productId}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Token a9b4424599bdfd8427acf9ed3be853f2749de5c6'
                }
            });
            
            if (res.ok) {
                loadProducts();
                showNotification('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            } else {
                showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'error');
            }
        } catch (error) {
            console.error('Error deleting product:', error);
            showNotification('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬', 'error');
        }
    }
}

// Event listeners
document.getElementById('addProductForm').addEventListener('submit', addProduct);

// Search functionality with real-time filtering
document.getElementById('searchInput').addEventListener('input', searchProducts);
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchProducts();
    }
});

// Category filter with real-time filtering
document.getElementById('categoryFilter').addEventListener('change', searchProducts);

// Clear search function
function clearSearch() {
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = '';
    
    // Remove any existing no results message
    const noResultsMessage = document.getElementById('noResultsMessage');
    if (noResultsMessage) {
        noResultsMessage.remove();
    }
    
    // Show all rows
    const productRows = document.querySelectorAll('#productsTableBody tr');
    productRows.forEach(row => {
        row.style.display = '';
        row.classList.remove('hidden');
    });
    
    // If no products are loaded, reload them
    if (productRows.length === 0 || (productRows.length === 1 && productRows[0].querySelector('[colspan]'))) {
        loadProducts();
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show loader while loading data
    PageLoader.show('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
    
    Promise.all([
        loadProducts(),
        loadCategories()
    ]).then(() => {
        // Hide loader after data is loaded
        PageLoader.hide();
        
        // Check QR Code library
        setTimeout(() => {
            if (typeof qrcode === 'undefined') {
                console.error('QRCode library failed to load');
                showNotification('Ù…ÙƒØªØ¨Ø© QR Code Ù„Ù… ØªØ­Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', 'warning');
            } else {
                console.log('QRCode library loaded successfully');
            }
        }, 1000);
    }).catch((error) => {
        console.error('Error loading data:', error);
        PageLoader.hide();
    });
});
</script>
{% endblock %}
